{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container py-5 mt-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="fw-bold">Painel de Controle de Rastreio</h1>
            <p class="text-muted">DoaÃ§Ã£o #{{ donation.id }}</p>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div id="adminMap" style="height: 600px; width: 100%;"></div>
        </div>
    </div>

    <div class="mt-3 text-center">
        <div id="statusMessage" class="alert alert-info d-none"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const startLat = {{ tracking.latitude| stringformat: ".6f"
    }};
    const startLng = {{ tracking.longitude| stringformat: ".6f" }};

    const map = L.map('adminMap').setView([startLat, startLng], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Current Truck Marker
    const truckIcon = L.divIcon({
        className: 'truck-icon',
        html: '<div style="font-size:30px;">ðŸšš</div>',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    let marker = L.marker([startLat, startLng], { icon: truckIcon, draggable: true }).addTo(map);

    function updatePosition(lat, lng) {
        fetch("{% url 'update_location' donation.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ lat: lat, lng: lng })
        })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.classList.remove('d-none', 'alert-danger');

                if (data.success) {
                    statusDiv.classList.add('alert-success');
                    statusDiv.innerText = `PosiÃ§Ã£o atualizada com sucesso! (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                    marker.setLatLng([lat, lng]);
                } else {
                    statusDiv.classList.add('alert-danger');
                    statusDiv.innerText = "Erro ao atualizar: " + data.error;
                }

                setTimeout(() => statusDiv.classList.add('d-none'), 3000);
            })
            .catch(err => console.error(err));
    }

    // Update on map click
    map.on('click', function (e) {
        updatePosition(e.latlng.lat, e.latlng.lng);
    });

    // Update on drag end
    marker.on('dragend', function (e) {
        const pos = marker.getLatLng();
        updatePosition(pos.lat, pos.lng);
    });
});
</script>
{% endblock %}